<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>Yurica · 통계</title>

  <!-- Firebase SDK (defer + Hosting init) -->
  <script src="/__/firebase/firebase-app-compat.js" defer></script>
  <script src="/__/firebase/firebase-auth-compat.js" defer></script>
  <script src="/__/firebase/firebase-firestore-compat.js" defer></script>
  <script src="/__/firebase/init.js" defer></script>

  <style>
    :root{--bg:#0b0f14;--panel:#11161d;--muted:#8a97a6;--text:#e6edf3;--border:#222f3b}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR"}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);background:rgba(11,15,20,.9);backdrop-filter:blur(6px)}
    h1{margin:0;font-size:18px}
    .badge{padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    .btn{appearance:none;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;font-size:14px}
    .btn:hover{border-color:#2a3849}
    .btn.primary{border-color:#224c2f;background:#0f1b14;color:#b8f1c7}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end;margin-bottom:12px}
    .filters{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .filters label{font-size:12px;color:#9fb0c3}
    input,select{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0e141b;color:#e6edf3;width:100%}
    .quick{display:flex;gap:8px;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;margin:10px 0}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#0e141b}
    .tab.active{outline:2px solid #2a3849}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    thead th{background:#0e141b;color:#9fb0c3;font-size:12px;text-align:left;padding:10px;border-bottom:1px solid var(--border)}
    tbody td{padding:10px;border-bottom:1px solid var(--border);vertical-align:middle}
    tbody tr:hover{background:rgba(255,255,255,.02)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0}
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#0e141b}
    .card h3{margin:0 0 6px 0;font-size:13px;color:#9fb0c3}
    .card .big{font-size:18px}
    @media(max-width:900px){.filters{grid-template-columns:1fr 1fr}.cards{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <button class="btn" onclick="location.href='/admin.html'">← 관리자</button>
      <h1>통계</h1>
      <span class="badge" id="auth-badge">Auth: —</span>
      <span class="badge" id="env-badge">env: —</span>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="btnExport">CSV 내보내기</button>
    </div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <div class="filters">
        <div>
          <label>시작일</label>
          <input type="date" id="startDate">
        </div>
        <div>
          <label>종료일</label>
          <input type="date" id="endDate">
        </div>
        <div>
          <label>정렬 기준</label>
          <select id="sortBy">
            <option value="qty-desc">판매수량 ↓</option>
            <option value="qty-asc">판매수량 ↑</option>
            <option value="rev-desc">매출 ↓</option>
            <option value="rev-asc">매출 ↑</option>
          </select>
        </div>
        <div>
          <label>채널</label>
          <select id="channel">
            <option value="">전체</option>
            <option>web</option><option>ios</option><option>android</option><option>pos</option>
          </select>
        </div>
        <div>
          <label>상태(주문)</label>
          <select id="status">
            <option value="">전체</option>
            <option>NEW</option><option>IN_PROGRESS</option><option>READY</option><option>COMPLETED</option><option>CANCELLED</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="quick">
            <button class="btn" data-q="today">오늘</button>
            <button class="btn" data-q="7">7일</button>
            <button class="btn" data-q="30">30일</button>
            <button class="btn" data-q="month">이번달</button>
          </div>
        </div>
      </div>
      <div>
        <button class="btn primary" id="btnRun">조회</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="summary">요약</div>
      <div class="tab" data-tab="byMenu">메뉴별</div>
      <div class="tab" data-tab="byCategory">카테고리별</div>
    </div>

    <!-- SUMMARY -->
    <section id="summary" class="panel">
      <div class="cards">
        <div class="card"><h3>총 매출</h3><div class="big mono" id="sumRevenue">$0.00</div></div>
        <div class="card"><h3>주문 수</h3><div class="big mono" id="sumOrders">0</div></div>
        <div class="card"><h3>평균 주문액</h3><div class="big mono" id="avgOrder">$0.00</div></div>
        <div class="card"><h3>판매 수량(총)</h3><div class="big mono" id="sumQty">0</div></div>
      </div>
      <h3 style="color:#9fb0c3">상위 10개 메뉴</h3>
      <table>
        <thead><tr><th>메뉴</th><th class="mono">수량</th><th class="mono">매출(AUD)</th></tr></thead>
        <tbody id="top10"></tbody>
      </table>
      <h3 style="color:#9fb0c3;margin-top:14px">하위 10개 메뉴</h3>
      <table>
        <thead><tr><th>메뉴</th><th class="mono">수량</th><th class="mono">매출(AUD)</th></tr></thead>
        <tbody id="bottom10"></tbody>
      </table>
    </section>

    <!-- BY MENU -->
    <section id="byMenu" class="panel" style="display:none">
      <table>
        <thead><tr>
          <th>메뉴</th><th>카테고리</th><th class="mono">수량</th><th class="mono">매출(AUD)</th>
        </tr></thead>
        <tbody id="tblByMenu"></tbody>
      </table>
    </section>

    <!-- BY CATEGORY -->
    <section id="byCategory" class="panel" style="display:none">
      <table>
        <thead><tr>
          <th>카테고리</th><th class="mono">수량</th><th class="mono">매출(AUD)</th>
        </tr></thead>
        <tbody id="tblByCategory"></tbody>
      </table>
    </section>
  </div>

  <script>
    // Firebase 준비 대기 (최대 5초)
    function whenFirebaseReady(cb){
      let tries=0; const t=setInterval(()=>{
        if(window.firebase && firebase.apps && typeof firebase.app==='function'){ clearInterval(t); cb(); }
        else if(++tries>100){ clearInterval(t); alert('초기화 오류: Firebase SDK 로드 실패'); }
      },50);
    }

    window.addEventListener('load', ()=>{
      whenFirebaseReady(()=>{
        const envBadge = document.getElementById('env-badge');
        const authBadge= document.getElementById('auth-badge');

        const startDate = document.getElementById('startDate');
        const endDate   = document.getElementById('endDate');
        const sortBy    = document.getElementById('sortBy');
        const channel   = document.getElementById('channel');
        const statusSel = document.getElementById('status');
        const btnRun    = document.getElementById('btnRun');
        const btnExport = document.getElementById('btnExport');

        const tabs = Array.from(document.querySelectorAll('.tab'));
        const panels = {
          summary: document.getElementById('summary'),
          byMenu: document.getElementById('byMenu'),
          byCategory: document.getElementById('byCategory')
        };

        const currency = new Intl.NumberFormat('en-AU',{style:'currency',currency:'AUD'});
        const TZ = 'Australia/Sydney';

        let db = firebase.firestore();
        let auth = firebase.auth();

        // 로그인 (익명 → 폴백 없음: 통계는 내부용 가정)
        (async()=>{
          try{ await auth.signInAnonymously(); authBadge.textContent='Auth: anonymous'; }
          catch{ authBadge.textContent='Auth: login required'; }
          const pid=(firebase.app().options?.projectId||'').toLowerCase();
          envBadge.textContent = `env: ${/dev|test/.test(pid)?'dev':'prod'}`;
        })();

        // 탭 전환
        tabs.forEach(tab=>{
          tab.addEventListener('click', ()=>{
            tabs.forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            Object.values(panels).forEach(p=>p.style.display='none');
            panels[tab.dataset.tab].style.display='block';
          });
        });

        // 날짜 기본값: 최근 7일
        setQuick('7');
        document.querySelectorAll('.quick .btn').forEach(b=>{
          b.addEventListener('click', ()=>{ setQuick(b.dataset.q); });
        });

        function setQuick(mode){
          const now = new Date();
          const end = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate())); // 오늘 00:00 UTC 기준
          let start = new Date(end);
          if(mode==='today'){ /* same day */ }
          else if(mode==='7'){ start.setUTCDate(start.getUTCDate()-6); }
          else if(mode==='30'){ start.setUTCDate(start.getUTCDate()-29); }
          else if(mode==='month'){ start = new Date(Date.UTC(now.getFullYear(), now.getMonth(), 1)); }
          // set as local date string (yyyy-mm-dd)
          startDate.value = isoDateOnly(start);
          endDate.value   = isoDateOnly(end);
        }
        function isoDateOnly(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }

        // 조회
        btnRun.addEventListener('click', async ()=>{
          const s = new Date(startDate.value+'T00:00:00Z');
          const e = new Date(endDate.value+'T23:59:59Z');
          await runStats(s, e, channel.value, statusSel.value, sortBy.value);
        });

        // CSV 내보내기 (현재 탭 데이터 기준)
        btnExport.addEventListener('click', ()=>{
          if(document.querySelector('.tab.active').dataset.tab==='byMenu'){
            exportTable('#tblByMenu', 'menu_stats.csv');
          }else if(document.querySelector('.tab.active').dataset.tab==='byCategory'){
            exportTable('#tblByCategory', 'category_stats.csv');
          }else{
            exportTable('#top10', 'top10.csv'); // 요약 탭은 Top10 기준으로
          }
        });

        function exportTable(sel, filename){
          const rows = Array.from(document.querySelectorAll(sel + ' tr'));
          if(rows.length===0){ alert('내보낼 데이터가 없습니다.'); return; }
          let csv = [];
          const header = Array.from(rows[0].closest('table').querySelectorAll('thead th')).map(th=>th.innerText.trim());
          csv.push(header.join(','));
          rows.forEach(tr=>{
            const tds = Array.from(tr.querySelectorAll('td')).map(td=> `"${td.innerText.replace(/"/g,'""')}"`);
            if(tds.length) csv.push(tds.join(','));
          });
          const blob = new Blob([csv.join('\n')], {type:'text/csv;charset=utf-8;'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          a.click();
          URL.revokeObjectURL(a.href);
        }

        // 메인 로직
        async function runStats(start, end, channelFilter, statusFilter, sortKey){
          // 메뉴 카테고리 맵 (이름->카테고리) : menu 컬렉션에서 로드
          const menuMap = await loadMenuMap();

          const orders = await fetchOrders(start, end, channelFilter, statusFilter);
          // 집계: 총합/아이템/카테고리
          let totalRevenue = 0, totalOrders = 0, totalQty = 0;

          const byMenu = new Map();     // name -> {qty, rev, category}
          const byCategory = new Map(); // cat  -> {qty, rev}

          for(const o of orders){
            totalOrders++;
            const orderTotal = typeof o.total==='number' ? o.total : sumItems(o.items);
            totalRevenue += orderTotal;

            for(const it of (o.items||[])){
              const name = it.name || '(unknown)';
              const qty  = Number(it.qty||0);
              const price= Number(it.price||0);
              const line = qty*price;
              totalQty += qty;

              const cat = menuMap.get(name)?.category || 'Other';

              // 메뉴별
              const m = byMenu.get(name) || {qty:0, rev:0, category:cat};
              m.qty += qty; m.rev += line; m.category = cat;
              byMenu.set(name, m);

              // 카테고리별
              const c = byCategory.get(cat) || {qty:0, rev:0};
              c.qty += qty; c.rev += line;
              byCategory.set(cat, c);
            }
          }

          // 요약 카드
          document.getElementById('sumRevenue').textContent = currency.format(round2(totalRevenue));
          document.getElementById('sumOrders').textContent  = totalOrders.toString();
          document.getElementById('avgOrder').textContent   = totalOrders? currency.format(round2(totalRevenue/totalOrders)) : '$0.00';
          document.getElementById('sumQty').textContent     = totalQty.toString();

          // 정렬 키 적용
          const sorter = makeSorter(sortKey);
          // 메뉴별 테이블
          const menuArr = Array.from(byMenu.entries()).map(([name,v])=>({name,category:v.category,qty:v.qty,rev:round2(v.rev)})).sort(sorter);
          renderTable('#tblByMenu', menuArr, ['name','category','qty','rev']);
          // 카테고리별
          const catArr = Array.from(byCategory.entries()).map(([cat,v])=>({category:cat,qty:v.qty,rev:round2(v.rev)})).sort(sorter);
          renderTable('#tblByCategory', catArr, ['category','qty','rev']);

          // TOP/BOTTOM 10 (수량 기준 고정)
          const byQtyDesc = [...menuArr].sort((a,b)=>b.qty-a.qty);
          renderTopBottom(byQtyDesc);
        }

        function round2(x){ return Math.round((x+Number.EPSILON)*100)/100; }
        function sumItems(items){ return (items||[]).reduce((s,i)=>s + (Number(i.qty||0)*Number(i.price||0)), 0); }
        function makeSorter(key){
          if(key==='qty-asc')  return (a,b)=> a.qty-b.qty || b.rev-a.rev;
          if(key==='qty-desc') return (a,b)=> b.qty-a.qty || b.rev-a.rev;
          if(key==='rev-asc')  return (a,b)=> a.rev-b.rev || b.qty-a.qty;
          return (a,b)=> b.rev-a.rev || b.qty-a.qty; // rev-desc
        }

        function renderTopBottom(arr){
          const top = arr.slice(0,10);
          const bot = [...arr].reverse().slice(0,10);
          const topBody = document.getElementById('top10');
          const botBody = document.getElementById('bottom10');
          topBody.innerHTML=''; botBody.innerHTML='';
          top.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(r.name)}</td><td class="mono">${r.qty}</td><td class="mono">${r.rev.toFixed(2)}</td>`; topBody.appendChild(tr); });
          bot.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(r.name)}</td><td class="mono">${r.qty}</td><td class="mono">${r.rev.toFixed(2)}</td>`; botBody.appendChild(tr); });
        }

        function renderTable(sel, rows, cols){
          const tb = document.querySelector(sel);
          tb.innerHTML='';
          rows.forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = cols.map(c=>{
              const v = r[c];
              if(c==='rev') return `<td class="mono">${v.toFixed(2)}</td>`;
              if(c==='qty') return `<td class="mono">${v}</td>`;
              return `<td>${esc(v)}</td>`;
            }).join('');
            tb.appendChild(tr);
          });
        }

        function esc(s){ return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

        async function loadMenuMap(){
          const map = new Map();
          // name을 키로 사용 (현재 orders.items에는 menuId가 없다고 가정)
          const snap = await db.collection('menu').get();
          snap.forEach(doc=>{
            const d=doc.data()||{};
            if(d.name) map.set(d.name, {category: d.category || 'Other'});
          });
          return map;
        }

        // 기간 내 orders 페이징 수집
        async function fetchOrders(start, end, channelFilter, statusFilter){
          // Firestore Timestamp로 변환
          const sTs = firebase.firestore.Timestamp.fromDate(start);
          const eTs = firebase.firestore.Timestamp.fromDate(end);
          let ref = db.collection('orders')
                      .where('createdAt','>=',sTs)
                      .where('createdAt','<=',eTs)
                      .orderBy('createdAt','asc');

          if(channelFilter) ref = ref.where('channel','==',channelFilter);
          // 상태는 필드가 있다면 클라이언트 필터로 처리(복합 where 인덱스 회피)
          const batch = 800; // 페이지 크기
          let results = [];
          let last = null;
          while(true){
            let q = ref.limit(batch);
            if(last) q = q.startAfter(last);
            const snap = await q.get();
            if(snap.empty) break;
            snap.forEach(doc=>{
              const d = doc.data()||{};
              if(statusFilter && d.status !== statusFilter) return; // 클라이언트 필터
              results.push({id:doc.id, ...d});
            });
            last = snap.docs[snap.docs.length-1];
            if(snap.size < batch) break;
          }
          return results;
        }

        // 최초 자동 조회 (최근 7일)
        (async()=>{
          const s = new Date(startDate.value+'T00:00:00Z');
          const e = new Date(endDate.value+'T23:59:59Z');
          await runStats(s,e,'','', 'qty-desc');
        })();
      });
    });
  </script>
</body>
</html>
